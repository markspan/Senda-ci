name: Build liblsl for Android (arm64-v8a)

on:
  workflow_dispatch:
  push:
    tags:
      - "liblsl-android-v*"

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-22.04

    env:
      ANDROID_API: "24"
      ABI: "arm64-v8a"
      CMAKE_VERSION: "3.6.4111459"
      NDK_DIRNAME: "android-ndk-r14b"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install system deps for old NDK (libncurses.so.5)
        shell: bash
        run: |
          set -euxo pipefail
          sudo apt-get update
          sudo apt-get install -y libncurses5 libtinfo5

      - name: Set up JDK 17 (for sdkmanager)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Install Android SDK (legacy cmdline-tools) + packages
        shell: bash
        run: |
          set -euxo pipefail

          export ANDROID_SDK_ROOT="$HOME/android-sdk"
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> "$GITHUB_ENV"
          echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> "$GITHUB_ENV"

          curl -L -o cmdline-tools.zip \
            "https://dl.google.com/android/repository/commandlinetools-linux-6858069_latest.zip"
          unzip -q cmdline-tools.zip -d "$ANDROID_SDK_ROOT/cmdline-tools"
          mv "$ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools" "$ANDROID_SDK_ROOT/cmdline-tools/latest"
          rm cmdline-tools.zip

          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH"

          # Accept licenses but don't spam the logs
          yes | sdkmanager --licenses > /dev/null || true

          sdkmanager \
            "platform-tools" \
            "platforms;android-24" \
            "cmake;3.6.4111459"

      - name: Install Android NDK r14b
        shell: bash
        run: |
          set -euxo pipefail
          cd "$ANDROID_SDK_ROOT"

          curl -L -o ndk-r14b.zip "https://dl.google.com/android/repository/android-ndk-r14b-linux-x86_64.zip"
          unzip -q ndk-r14b.zip
          rm ndk-r14b.zip

          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/android-ndk-r14b" >> "$GITHUB_ENV"
          echo "NDK_HOME=$ANDROID_SDK_ROOT/android-ndk-r14b" >> "$GITHUB_ENV"

      - name: Build liblsl (arm64-v8a)
        shell: bash
        run: |
          set -euo pipefail

          # Force the same CMake as used by the app build (CMake 3.6)
          export CMAKE_SDK_DIR="$ANDROID_SDK_ROOT/cmake/${CMAKE_VERSION}"
          export PATH="${CMAKE_SDK_DIR}/bin:$PATH"
          which cmake
          cmake --version

          # Locate liblsl source dir
          if [[ -f "$GITHUB_WORKSPACE/senda/liblsl/CMakeLists.txt" ]]; then
            SRC_DIR="$GITHUB_WORKSPACE/senda/liblsl"
          elif [[ -f "$GITHUB_WORKSPACE/liblsl/CMakeLists.txt" ]]; then
            SRC_DIR="$GITHUB_WORKSPACE/liblsl"
          else
            echo "ERROR: Can't find CMakeLists.txt in senda/liblsl or liblsl."
            find "$GITHUB_WORKSPACE" -maxdepth 4 -name CMakeLists.txt -print
            exit 1
          fi

          echo "SRC_DIR=$SRC_DIR"
          test -f "$SRC_DIR/CMakeLists.txt"

          TOOLCHAIN="${ANDROID_NDK_HOME}/build/cmake/android.toolchain.cmake"
          test -f "$TOOLCHAIN"

          BUILD_DIR="${SRC_DIR}/build-android-${ABI}"
          rm -rf "$BUILD_DIR"
          mkdir -p "$BUILD_DIR"

          # IMPORTANT: CMake 3.6 (rc2) in the Android SDK is unreliable with -S/-B.
          # Use classic "cd build && cmake <src>" style.
          pushd "$BUILD_DIR" >/dev/null
          cmake "$SRC_DIR" \
            -DCMAKE_TOOLCHAIN_FILE="$TOOLCHAIN" \
            -DANDROID_ABI="$ABI" \
            -DANDROID_PLATFORM="android-${ANDROID_API}" \
            -DCMAKE_BUILD_TYPE=Release \
            -DTHREADS_PTHREAD_ARG=0 \
            -DCMAKE_THREAD_LIBS_INIT="" \
            -DCMAKE_HAVE_THREADS_LIBRARY=1 \
            -DCMAKE_USE_PTHREADS_INIT=1
          cmake --build . -- -j"$(nproc)"
          popd >/dev/null

          OUT_SO_DIR="${SRC_DIR}/out-android-so/${ABI}"
          rm -rf "${SRC_DIR}/out-android-so"
          mkdir -p "$OUT_SO_DIR"

          SO_PATH="$(find "$BUILD_DIR" -type f -name "liblsl*.so" | head -n 1 || true)"
          if [[ -z "${SO_PATH}" ]]; then
            echo "ERROR: No liblsl*.so found."
            find "$BUILD_DIR" -type f -name "*.so" | head -n 200
            exit 1
          fi

          cp "$SO_PATH" "$OUT_SO_DIR/liblsl.so"
          echo "OK -> $OUT_SO_DIR/liblsl.so"
          find "${SRC_DIR}/out-android-so" -type f -maxdepth 3 -print

      - name: Package artifact (tar.gz)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            VER="${GITHUB_REF_NAME}"
          else
            VER="sha-${GITHUB_SHA:0:7}"
          fi

          if [[ -d "$GITHUB_WORKSPACE/senda/liblsl/out-android-so" ]]; then
            PKG_ROOT="$GITHUB_WORKSPACE/senda/liblsl/out-android-so"
          else
            PKG_ROOT="$GITHUB_WORKSPACE/liblsl/out-android-so"
          fi

          tar -czf "dist/liblsl-android-${VER}.tar.gz" -C "$PKG_ROOT" .
          ls -la dist

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: liblsl-android-arm64
          path: dist/*.tar.gz
          if-no-files-found: error

  release:
    if: github.ref_type == 'tag'
    needs: build-android
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: liblsl-android-arm64
          path: dist

      - name: Create GitHub Release (liblsl Android)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            dist/*.tar.gz
