name: Build liblsl for Android (arm64-v8a)

on:
  workflow_dispatch:
    inputs:
      android_api:
        description: "Android API level"
        required: false
        default: "24"
  push:
    tags:
      - "liblsl-android-v*"

permissions:
  contents: write

jobs:
  build-android:
    runs-on: ubuntu-22.04

    env:
      # liblsl lives at repo root in ./liblsl (contains CMakeLists.txt)
      LIBLSL_DIR: liblsl

      # Match the app build toolchain choices
      ANDROID_API: ${{ inputs.android_api || '24' }}
      ABI: arm64-v8a
      CMAKE_VERSION: 3.6.4111459
      NDK_DIRNAME: android-ndk-r14b

    steps:
      - uses: actions/checkout@v4

      - name: Install ncurses5 compatibility (needed by NDK r14b clang)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update

          # First try native .so.5 packages (may or may not exist on the runner image)
          if sudo apt-get install -y libncurses5 libtinfo5; then
            echo "Installed libncurses5/libtinfo5."
            exit 0
          fi

          # Fallback: install ncurses6 and provide libncurses.so.5 + libtinfo.so.5 via symlinks
          sudo apt-get install -y libncurses6 libtinfo6

          LIBDIR="/usr/lib/x86_64-linux-gnu"
          sudo ln -sf "${LIBDIR}/libncurses.so.6" "${LIBDIR}/libncurses.so.5"
          sudo ln -sf "${LIBDIR}/libtinfo.so.6"   "${LIBDIR}/libtinfo.so.5"

          ls -la "${LIBDIR}/libncurses.so."* "${LIBDIR}/libtinfo.so."*

      # sdkmanager (modern) requires Java 17+
      - name: Set up JDK 17 (for sdkmanager)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # Use the same approach as the app workflow: fresh SDK root + legacy cmdline-tools
      - name: Install Android SDK (legacy cmdline-tools) + packages
        shell: bash
        run: |
          set -euxo pipefail

          export ANDROID_SDK_ROOT="$HOME/android-sdk"
          mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> "$GITHUB_ENV"
          echo "ANDROID_HOME=$ANDROID_SDK_ROOT" >> "$GITHUB_ENV"

          curl -L -o cmdline-tools.zip \
            "https://dl.google.com/android/repository/commandlinetools-linux-6858069_latest.zip"
          unzip -q cmdline-tools.zip -d "$ANDROID_SDK_ROOT/cmdline-tools"
          mv "$ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools" "$ANDROID_SDK_ROOT/cmdline-tools/latest"
          rm cmdline-tools.zip

          export PATH="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH"

          # Accept licenses (avoid pipefail tripping on SIGPIPE from `yes`)
          yes | sdkmanager --licenses || true

          # Install the EXACT CMake package used by the app build
          sdkmanager \
            "platform-tools" \
            "platforms;android-${ANDROID_API}" \
            "cmake;${CMAKE_VERSION}"

      - name: Install Android NDK r14b
        shell: bash
        run: |
          set -euxo pipefail
          cd "$ANDROID_SDK_ROOT"

          curl -L -o ndk-r14b.zip "https://dl.google.com/android/repository/android-ndk-r14b-linux-x86_64.zip"
          unzip -q ndk-r14b.zip
          rm ndk-r14b.zip

          echo "ANDROID_NDK_HOME=$ANDROID_SDK_ROOT/${NDK_DIRNAME}" >> "$GITHUB_ENV"
          echo "NDK_HOME=$ANDROID_SDK_ROOT/${NDK_DIRNAME}" >> "$GITHUB_ENV"

      - name: Diagnostics (SDK/CMake/NDK)
        shell: bash
        run: |
          set -euxo pipefail
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT"
          echo "ANDROID_NDK_HOME=${ANDROID_NDK_HOME:-}"
          echo "CMake SDK dir:"
          ls -la "$ANDROID_SDK_ROOT/cmake" || true
          echo "CMake version:"
          "$ANDROID_SDK_ROOT/cmake/${CMAKE_VERSION}/bin/cmake" --version

      - name: Build liblsl .so (arm64-v8a)
        shell: bash
        working-directory: ${{ env.LIBLSL_DIR }}
        run: |
          set -euo pipefail

          # Force the same CMake as used by the app build
          CMAKE_SDK_DIR="${ANDROID_SDK_ROOT}/cmake/${CMAKE_VERSION}"
          export PATH="${CMAKE_SDK_DIR}/bin:$PATH"
          which cmake
          cmake --version

          SRC_DIR="$(pwd)"
          echo "SRC_DIR=${SRC_DIR}"

          TOOLCHAIN="${ANDROID_NDK_HOME}/build/cmake/android.toolchain.cmake"
          echo "Using NDK: ${ANDROID_NDK_HOME}"
          test -f "$TOOLCHAIN"

          OUT_SO_DIR="${SRC_DIR}/out-android-so/${ABI}"
          rm -rf "${SRC_DIR}/out-android-so"
          mkdir -p "$OUT_SO_DIR"

          BUILD_DIR="${SRC_DIR}/build-android-${ABI}"
          rm -rf "$BUILD_DIR"
          mkdir -p "$BUILD_DIR"

          cmake -S "$SRC_DIR" -B "$BUILD_DIR" \
            -DCMAKE_TOOLCHAIN_FILE="$TOOLCHAIN" \
            -DANDROID_ABI="$ABI" \
            -DANDROID_PLATFORM="android-${ANDROID_API}" \
            -DANDROID_STL="c++_shared" \
            -DCMAKE_BUILD_TYPE=Release \
            -DLSL_USE_SYSTEM_BOOST=OFF \
            -DLSL_BUILD_STATIC=OFF

          cmake --build "$BUILD_DIR" -j

          SO_PATH="$(find "$BUILD_DIR" -type f -name "liblsl*.so" | head -n 1 || true)"
          if [[ -z "${SO_PATH}" ]]; then
            echo "ERROR: No liblsl*.so found for ABI ${ABI}"
            echo "Found .so files:"
            find "$BUILD_DIR" -type f -name "*.so" | head -n 200
            exit 1
          fi

          cp "$SO_PATH" "$OUT_SO_DIR/liblsl.so"
          echo "OK -> ${OUT_SO_DIR}/liblsl.so"

          echo "Final outputs:"
          find "${SRC_DIR}/out-android-so" -type f -maxdepth 3 -print

      - name: Package artifact (tar.gz)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist

          if [[ "${GITHUB_REF_TYPE}" == "tag" ]]; then
            VER="${GITHUB_REF_NAME}"
          else
            VER="sha-${GITHUB_SHA:0:7}"
          fi

          tar -czf "dist/liblsl-android-${VER}.tar.gz" -C "liblsl/out-android-so" .
          ls -la dist

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: liblsl-android
          path: dist/*.tar.gz
          if-no-files-found: error

  release:
    if: github.ref_type == 'tag'
    needs: build-android
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: liblsl-android
          path: dist

      - name: Create GitHub Release (liblsl Android)
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            dist/*.tar.gz
